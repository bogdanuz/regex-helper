<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RegexHelper v4.0 - Test Runner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', 'Consolas', monospace;
            background: #000;
            color: #0f0;
            font-size: 12px;
            line-height: 1.4;
            padding: 8px;
        }

        .container {
            max-width: 100%;
            height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .header {
            background: #111;
            padding: 6px 8px;
            border: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 13px;
            font-weight: normal;
            color: #0f0;
        }

        .header-stats {
            color: #888;
            font-size: 11px;
        }

        .main {
            display: flex;
            gap: 4px;
            flex: 1;
            overflow: hidden;
        }

        .left-panel {
            width: 500px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .test-list-container {
            flex: 1;
            background: #111;
            border: 1px solid #333;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .test-list {
            width: 100%;
        }

        .test-item {
            display: flex;
            align-items: center;
            padding: 4px 6px;
            border-bottom: 1px solid #222;
            cursor: pointer;
            transition: background 0.1s;
        }

        .test-item:hover {
            background: #1a1a1a;
        }

        .test-item input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .test-info {
            flex: 1;
            min-width: 0;
        }

        .test-name {
            color: #0f0;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .test-meta {
            color: #666;
            font-size: 10px;
            margin-top: 2px;
        }

        .controls {
            background: #111;
            border: 1px solid #333;
            padding: 6px 8px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .btn {
            background: #222;
            color: #0f0;
            border: 1px solid #333;
            padding: 4px 12px;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.1s;
        }

        .btn:hover {
            background: #333;
            border-color: #0f0;
        }

        .btn:active {
            background: #0f0;
            color: #000;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-primary {
            border-color: #0f0;
        }

        .info {
            flex: 1;
            color: #666;
            font-size: 11px;
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stats-bar {
            background: #111;
            border: 1px solid #333;
            padding: 6px 8px;
            display: flex;
            gap: 20px;
        }

        .stat {
            font-size: 11px;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            color: #0f0;
            margin-left: 6px;
        }

        .stat-value.passed { color: #0f0; }
        .stat-value.failed { color: #f00; }

        .logs-container {
            flex: 1;
            background: #000;
            border: 1px solid #333;
            overflow-y: auto;
            overflow-x: hidden;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            padding: 6px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .logs-container:empty::before {
            content: '> Waiting for tests...';
            color: #666;
        }

        .log-line {
            margin-bottom: 2px;
        }

        .log-success { color: #0f0; }
        .log-error { color: #f00; }
        .log-info { color: #0ff; }
        .log-muted { color: #666; }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #000;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .spinner {
            display: inline-block;
            width: 8px;
            height: 8px;
            border: 2px solid #333;
            border-top-color: #0f0;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>[REGEX HELPER v4.0 - TEST RUNNER]</h1>
            <div class="header-stats" id="headerStats">READY</div>
        </div>

        <!-- Main -->
        <div class="main">
            <!-- Left Panel -->
            <div class="left-panel">
                <!-- Test List -->
                <div class="test-list-container">
                    <div class="test-list" id="testList"></div>
                </div>

                <!-- Controls -->
                <div class="controls">
                    <button class="btn btn-primary" id="runBtn">
                        <span id="runText">RUN</span>
                    </button>
                    <button class="btn" id="selectAllBtn">SELECT ALL</button>
                    <button class="btn" id="clearBtn">CLEAR</button>
                    <button class="btn" id="copyBtn">COPY LOGS</button>
                    <div class="info" id="selectedInfo">0 selected</div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Stats -->
                <div class="stats-bar">
                    <div class="stat">
                        <span class="stat-label">TOTAL:</span>
                        <span class="stat-value" id="totalTests">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">PASSED:</span>
                        <span class="stat-value passed" id="passedTests">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">FAILED:</span>
                        <span class="stat-value failed" id="failedTests">0</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">RATE:</span>
                        <span class="stat-value" id="passRate">0.0%</span>
                    </div>
                </div>

                <!-- Logs -->
                <div class="logs-container" id="logs"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { TEST_SUITES } from './tests/test-config.js';

        let selectedTests = new Set();
        let isRunning = false;
        let consoleLogBuffer = [];

        // Сортировка: новые сверху
        const sortedSuites = [...TEST_SUITES].sort((a, b) => {
            return new Date(b.date) - new Date(a.date);
        });

        // Перехват console.log
        const originalLog = console.log;
        const originalError = console.error;

        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg);
                }
                return String(arg);
            }).join(' ');
            consoleLogBuffer.push(message);
            appendLog(message);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.map(arg => String(arg)).join(' ');
            consoleLogBuffer.push('[ERROR] ' + message);
            appendLog('[ERROR] ' + message, 'error');
        };

        function init() {
            renderTestList();
            setupEventListeners();
            updateSelectedInfo();
        }

        function renderTestList() {
            const container = document.getElementById('testList');
            
            if (sortedSuites.length === 0) {
                container.innerHTML = '<div style="padding:20px;color:#666;">NO TESTS FOUND</div>';
                return;
            }

            container.innerHTML = sortedSuites.map(suite => `
                <div class="test-item">
                    <input 
                        type="checkbox" 
                        id="test-${suite.id}" 
                        ${suite.enabled ? 'checked' : ''}
                        data-suite-id="${suite.id}"
                    >
                    <div class="test-info">
                        <div class="test-name">${suite.name}</div>
                        <div class="test-meta">${suite.file} | ${suite.estimatedTests} tests | v${suite.version} | ${suite.date}</div>
                    </div>
                </div>
            `).join('');

            sortedSuites.forEach(suite => {
                if (suite.enabled) {
                    selectedTests.add(suite.id);
                }
            });
        }

        function setupEventListeners() {
            document.getElementById('testList').addEventListener('change', (e) => {
                if (e.target.type === 'checkbox') {
                    const suiteId = e.target.dataset.suiteId;
                    if (e.target.checked) {
                        selectedTests.add(suiteId);
                    } else {
                        selectedTests.delete(suiteId);
                    }
                    updateSelectedInfo();
                }
            });

            document.getElementById('runBtn').addEventListener('click', runTests);
            document.getElementById('selectAllBtn').addEventListener('click', selectAll);
            document.getElementById('clearBtn').addEventListener('click', clearResults);
            document.getElementById('copyBtn').addEventListener('click', copyLogs);
        }

        function selectAll() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
                const suiteId = cb.dataset.suiteId;
                if (cb.checked) {
                    selectedTests.add(suiteId);
                } else {
                    selectedTests.delete(suiteId);
                }
            });
            
            updateSelectedInfo();
        }

        function updateSelectedInfo() {
            const count = selectedTests.size;
            const totalTests = sortedSuites
                .filter(s => selectedTests.has(s.id))
                .reduce((sum, s) => sum + s.estimatedTests, 0);

            document.getElementById('selectedInfo').textContent = 
                count === 0 ? '0 selected' : `${count} file(s) | ~${totalTests} tests`;
        }

        async function runTests() {
            if (isRunning) return;
            if (selectedTests.size === 0) {
                appendLog('[ERROR] No tests selected', 'error');
                return;
            }

            isRunning = true;
            updateRunButton(true);
            clearResults();
            consoleLogBuffer = [];

            const startTime = Date.now();
            document.getElementById('headerStats').textContent = 'RUNNING...';

            for (const suiteId of selectedTests) {
                const suite = sortedSuites.find(s => s.id === suiteId);
                if (!suite) continue;

                try {
                    await import(`./tests/${suite.file}?t=${Date.now()}`);
                } catch (error) {
                    appendLog(`[ERROR] Failed to load ${suite.file}: ${error.message}`, 'error');
                }
            }

            const duration = Date.now() - startTime;
            document.getElementById('headerStats').textContent = `COMPLETED IN ${duration}ms`;

            setTimeout(() => {
                updateRunButton(false);
                isRunning = false;
            }, 500);
        }

        function appendLog(message, type = 'info') {
            const logsEl = document.getElementById('logs');
            const line = document.createElement('div');
            line.className = `log-line log-${type}`;
            line.textContent = message;
            logsEl.appendChild(line);
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        async function copyLogs() {
            if (consoleLogBuffer.length === 0) {
                appendLog('[ERROR] No logs to copy', 'error');
                return;
            }

            try {
                await navigator.clipboard.writeText(consoleLogBuffer.join('\n'));
                appendLog('[OK] Logs copied to clipboard', 'success');
            } catch (error) {
                appendLog('[ERROR] Failed to copy logs', 'error');
            }
        }

        function clearResults() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('totalTests').textContent = '0';
            document.getElementById('passedTests').textContent = '0';
            document.getElementById('failedTests').textContent = '0';
            document.getElementById('passRate').textContent = '0.0%';
            document.getElementById('headerStats').textContent = 'READY';
            consoleLogBuffer = [];
        }

        function updateRunButton(running) {
            const btn = document.getElementById('runBtn');
            const text = document.getElementById('runText');

            if (running) {
                btn.disabled = true;
                text.innerHTML = '<span class="spinner"></span> RUNNING';
            } else {
                btn.disabled = false;
                text.textContent = 'RUN';
            }
        }

        // Слушаем события из тестов
        window.addEventListener('message', (event) => {
            if (event.data.type === 'test-stats') {
                const { total, passed, failed } = event.data;
                document.getElementById('totalTests').textContent = total || 0;
                document.getElementById('passedTests').textContent = passed || 0;
                document.getElementById('failedTests').textContent = failed || 0;
                
                const rate = total > 0 ? ((passed / total) * 100).toFixed(1) : '0.0';
                document.getElementById('passRate').textContent = rate + '%';
            }
        });

        init();
    </script>
</body>
</html>
